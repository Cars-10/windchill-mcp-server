<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="mb-1">
            üîß Windchill MCP Interface
          </h1>
          <p class="text-muted mb-0">Model Context Protocol Tools for PTC Windchill</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- Windchill Server Selector - Always show if servers are available -->
          <div class="d-flex align-items-center" *ngIf="availableServers.length > 0">
            <label class="text-muted me-2 mb-0" style="font-size: 0.875rem; white-space: nowrap;">Windchill Server:</label>
            <select
              class="form-select form-select-sm"
              style="width: auto; min-width: 200px;"
              [(ngModel)]="selectedServerId"
              (change)="onServerChange()"
              [disabled]="switchingServer || loading || availableServers.length <= 1">
              <option *ngFor="let server of availableServers" [value]="server.id">
                {{ server.name }}
              </option>
            </select>
          </div>

          <!-- Server Status Badge -->
          <span class="badge bg-success me-2 d-flex flex-column align-items-center" *ngIf="serverStatus === 'connected' && currentServer">
            <span>‚úÖ {{ currentServer.name }} Connected</span>
            <a [href]="currentServer.url" target="_blank" class="text-decoration-underline" style="font-size: 0.65rem; font-weight: normal; color: #6eb5ff;" title="Open Windchill Server">{{ currentServer.url }}</a>
          </span>
          <span class="badge bg-danger me-2" *ngIf="serverStatus === 'disconnected'">
            ‚ùå {{ currentServer?.name || 'Server' }} Disconnected
          </span>

          <!-- Switching Indicator -->
          <span class="badge bg-warning text-dark me-2" *ngIf="switchingServer">
            ‚è≥ Switching Server...
          </span>

          <!-- Refresh Button -->
          <button class="btn btn-outline-primary btn-sm" (click)="refreshTools()" [disabled]="loading || switchingServer">
            <span *ngIf="loading || switchingServer">üîÑ</span>
            <span *ngIf="!loading && !switchingServer">üîÑ</span>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="row mb-4" *ngIf="tools.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <input
                type="text"
                class="form-control"
                placeholder="Search tools..."
                [(ngModel)]="searchTerm"
                (input)="onSearchInput()">
            </div>
            <div class="col-md-3">
              <select class="form-select" [(ngModel)]="selectedAgent" (change)="onFilterChange()">
                <option value="">All Agents</option>
                <option *ngFor="let agent of agents" [value]="agent">{{agent}}</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" [(ngModel)]="selectedCategory" (change)="onFilterChange()">
                <option value="">All Categories</option>
                <option value="lifecycle">Lifecycle</option>
                <option value="version">Version Management</option>
                <option value="content">Content Management</option>
                <option value="relationship">Relationship Management</option>
                <option value="search">Search</option>
                <option value="bulk">Bulk Operations</option>
              </select>
            </div>
            <div class="col-md-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showSchemas" [(ngModel)]="showSchemas">
                <label class="form-check-label" for="showSchemas">
                  Show Schemas
                </label>
              </div>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" *ngIf="hasActiveFilters()">
                  üîç Filters active: <span *ngIf="selectedAgent">Agent: {{selectedAgent}}</span><span *ngIf="selectedCategory"> ‚Ä¢ Category: {{selectedCategory}}</span><span *ngIf="searchTerm"> ‚Ä¢ Search: "{{searchTerm}}"</span>
                </small>
                <button class="btn btn-outline-secondary btn-sm" (click)="clearAllFilters()" *ngIf="hasActiveFilters()" title="Clear all filters and reset to defaults">
                  üóëÔ∏è Clear Filters
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tools Grid -->
  <div class="row" *ngIf="filteredTools.length > 0; else noTools">
    <div class="col-md-6 col-lg-3 mb-3" *ngFor="let tool of filteredTools">
      <div class="card tool-card h-100" [class.border-primary]="selectedTool?.name === tool.name">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="badge bg-secondary agent-badge">{{tool.agent}}</span>
          <button class="btn btn-primary btn-sm execute-btn"
                  (click)="selectTool(tool)"
                  [disabled]="loading"
                  title="Open parameter form to execute this tool">
            ‚ñ∂Ô∏è Execute
          </button>
        </div>
        <div class="card-body p-2">
          <h6 class="card-title mb-2">{{tool.name}}</h6>
          <p class="card-text text-muted small mb-2">{{tool.description}}</p>

          <div *ngIf="showSchemas && tool.inputSchema" class="small">
            <small class="text-muted">Parameters:</small>
            <div class="params-list">
              <div *ngFor="let param of getParameterNames(tool.inputSchema)">
                <code class="param-code">{{param}}</code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Tools Message -->
  <ng-template #noTools>
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <div style="font-size: 3rem; margin-bottom: 1rem;">
            <span *ngIf="loading">‚è≥</span>
            <span *ngIf="!loading && tools.length === 0">üîß</span>
          </div>
          <h4 *ngIf="loading">Loading Tools...</h4>
          <h4 *ngIf="!loading && tools.length === 0">No Tools Available</h4>
          <p class="text-muted" *ngIf="!loading && tools.length === 0">
            Make sure the Windchill MCP Server is running and accessible.
          </p>
          <button *ngIf="!loading && tools.length === 0"
                  class="btn btn-primary"
                  (click)="refreshTools()">
            üîÑ Try Again
          </button>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Tool Execution Modal -->
  <div class="modal-overlay" *ngIf="showExecutionModal && selectedTool" (click)="closeExecutionModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <span class="icon">üîß</span>
          Execute Tool: {{selectedTool.name}}
        </h3>
        <button type="button" class="close-button" (click)="closeExecutionModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <p class="tool-description">{{selectedTool.description}}</p>

        <!-- Parameter Form -->
        <form (ngSubmit)="executeTool($event)" #toolForm="ngForm" class="parameter-form">
          <!-- No parameters message -->
          <div *ngIf="(getToolParameters(selectedTool)?.length || 0) === 0" class="no-parameters">
            <p class="text-muted">
              ‚ÑπÔ∏è This tool doesn't require any parameters. Click "Execute Tool" to run it.
            </p>
          </div>

          <!-- Instructions for tools with parameters -->
          <div *ngIf="(getToolParameters(selectedTool)?.length || 0) > 0" class="parameters-instructions">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <p class="text-muted small mb-0">
                üí° Enter the parameters below and click "Execute Tool" to run the tool.
              </p>
              <div class="parameter-summary">
                <span class="badge bg-primary me-2">{{getRequiredParameterCount()}} Required</span>
                <span class="badge bg-secondary">{{getOptionalParameterCount()}} Optional</span>
              </div>
            </div>
          </div>

          <!-- Parameters -->
          <div *ngFor="let param of (getToolParameters(selectedTool) || [])" class="form-group" [class.required-param]="isRequired(selectedTool, param.name)">
            <label class="form-label" [class.required-label]="isRequired(selectedTool, param.name)">
              {{param.name}}
              <span class="param-type">({{param.type}})</span>
              <span class="required-indicator" *ngIf="isRequired(selectedTool, param.name)">*</span>
              <span class="optional-indicator" *ngIf="!isRequired(selectedTool, param.name)">optional</span>
            </label>

            <!-- String input -->
            <input *ngIf="param.type === 'string'"
                   type="text"
                   class="form-input"
                   [id]="'param_' + param.name"
                   [name]="param.name"
                   [(ngModel)]="parameters[param.name]"
                   [required]="isRequired(selectedTool, param.name)"
                   [placeholder]="param.description">

            <!-- Number input -->
            <input *ngIf="param.type === 'number'"
                   type="number"
                   class="form-input"
                   [id]="'param_' + param.name"
                   [name]="param.name"
                   [(ngModel)]="parameters[param.name]"
                   [required]="isRequired(selectedTool, param.name)"
                   [placeholder]="param.description">

            <!-- Boolean input -->
            <div *ngIf="param.type === 'boolean'" class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox"
                       [id]="'param_' + param.name"
                       [name]="param.name"
                       [(ngModel)]="parameters[param.name]">
                <span class="checkmark"></span>
                {{param.description}}
              </label>
            </div>

            <!-- Array input -->
            <textarea *ngIf="param.type === 'array'"
                     class="form-textarea"
                     rows="3"
                     [id]="'param_' + param.name"
                     [name]="param.name"
                     [(ngModel)]="parameters[param.name]"
                     placeholder='Enter JSON array, e.g., ["item1", "item2"]'
                     [required]="isRequired(selectedTool, param.name)"></textarea>

            <!-- Object input -->
            <textarea *ngIf="param.type === 'object'"
                     class="form-textarea"
                     rows="4"
                     [name]="param.name"
                     [(ngModel)]="parameters[param.name]"
                     placeholder="Enter JSON object, e.g., {&quot;key&quot;: &quot;value&quot;}"
                     [required]="isRequired(selectedTool, param.name)"></textarea>

          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary" [disabled]="executing">
              <span *ngIf="executing">‚è≥</span>
              <span *ngIf="!executing">‚ñ∂Ô∏è</span>
              {{executing ? 'Executing...' : 'Execute Tool'}}
            </button>
            <button type="button" class="btn btn-secondary" (click)="closeExecutionModal()">
              Cancel
            </button>
          </div>
        </form>

        <!-- Execution Results -->
        <div *ngIf="executionResult" class="execution-results">
          <h4>Execution Result:</h4>
          <div class="result-success" *ngIf="executionResult.success">
            <!-- Compact Variables View -->
            <div *ngIf="getResultVariables(executionResult.data).length > 0" class="variables-summary mb-3">
              <h6 class="mb-2">üìä Response Summary:</h6>
              <div class="variables-grid">
                <div *ngFor="let variable of getResultVariables(executionResult.data)" class="variable-item">
                  <span class="variable-name">{{variable.name}}:</span>
                  <span class="variable-value">{{variable.value}}</span>
                </div>
              </div>
            </div>

            <!-- Full JSON Display -->
            <details class="mt-3">
              <summary class="json-toggle">üîç View Full JSON Response</summary>
              <pre class="json-display">{{safeJsonDisplay(executionResult.data)}}</pre>
            </details>
          </div>
          <div class="result-error" *ngIf="!executionResult.success">
            <strong>‚ùå Error:</strong> {{executionResult.error}}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Loading Overlay -->
  <div class="global-loading-overlay" *ngIf="loading">
    <div class="loading-spinner">
      <div class="spinner-emoji">‚è≥</div>
      <div class="loading-text">Loading Tools...</div>
    </div>
  </div>
</div>